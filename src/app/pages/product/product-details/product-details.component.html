<div [innerHTML]="jsonLd"></div>

<div class="details">
  <ng-container *ngFor="let entry of indices | keyvalue: keyValuePipeComparator" [ngSwitch]="entry.value">

    <div class="details__title"
         [class.details__title--active]="activeIdx === entry.value"
         (click)="toggleContent(entry.value)"
    >
      <ng-container *ngSwitchCase="indices.description">Описание</ng-container>
      <ng-container *ngSwitchCase="indices.chars">Характеристики</ng-container>
      <ng-container *ngSwitchCase="indices.reviews">
        Отзывы
        <span class="details__reviews-count" *ngIf="product.reviewsCount > 0">({{ product.reviewsCount }})</span>
      </ng-container>

      <i class="mbi mbi-chevron-down details__title-icon"
         [class.details__title-icon--active]="activeIdx === entry.value"
      ></i>
    </div>

    <div class="details__content" [class.details__content--visible]="activeIdx === entry.value">

      <ng-container *ngSwitchCase="indices.description" [ngTemplateOutlet]="descTmpl"></ng-container>
      <ng-container *ngSwitchCase="indices.chars" [ngTemplateOutlet]="charsTmpl"></ng-container>
      <ng-container *ngSwitchCase="indices.reviews" [ngTemplateOutlet]="reviewsTmpl"></ng-container>

    </div>

  </ng-container>
</div>


<ng-template #descTmpl>
  <div class="description product-description" [innerHTML]="product.fullDescription"></div>
</ng-template>

<ng-template #charsTmpl>
  <div class="chars">
    <div class="chars__item" *ngFor="let char of product.characteristics">
      <div class="chars__label">{{ char.label }}</div>
      <div class="chars__value">{{ char.value }}</div>
    </div>
  </div>
</ng-template>

<ng-template #reviewsTmpl>
  <div class="reviews">

    <div class="reviews__add">
      Оставьте свой отзыв об этом товаре

      <button class="reviews__add-btn" (click)="openReviewModal()" type="button">Написать отзыв</button>
    </div>

    <div class="review" *ngFor="let review of reviews">
      <div class="review__votes-count" *ngIf="review.votesCount > 0">
        Этот отзыв поддержали {{ review.votesCount }} раз
      </div>

      <rating-stars class="review__rating" [rating]="review.rating"></rating-stars>

      <div class="review__name-container">
        <span class="review__name">{{ review.name }}</span><span class="review__date"> {{ review.createdAt | date }}</span>
      </div>

      <div class="review__text">
        {{ review.text }}
      </div>

      <review-gallery class="review__medias" *ngIf="review.medias.length" [medias]="review.medias"></review-gallery>

      <div class="review__actions">
        <button class="review__add-comment" (click)="toggleCommentForm(review)" type="button">
          Ответить
        </button>

        <div class="review__vote" *ngIf="!review.hasClientVoted">
          <ng-container *ngIf="voteSuccess; else voteBtns">
            Спасибо за Ваше мнение
          </ng-container>

          <ng-template #voteBtns>
            Поддержать?
            <button class="review__vote-btn" (click)="vote(review)" type="button">Да</button>
            <button class="review__vote-btn" (click)="downvote(review)" type="button">Нет</button>
          </ng-template>
        </div>
      </div>

      <div class="review__comment" *ngFor="let comment of review.comments">
        <div class="review__name-container">
          <span class="review__name">{{ comment.name }}</span><span class="review__date"> {{ comment.createdAt | date }}</span>
        </div>

        <div class="review__comment-text">
          {{ comment.text }}
        </div>
      </div>

      <form class="review__comment review__comment-form comment-form"
            *ngIf="review.isCommentFormVisible"
            (ngSubmit)="onCommentFormSubmit(review, form.value)"
            ngNativeValidate
            #form="ngForm"
      >
        <div class="comment-form__title">
          Оставить комментарий
        </div>

        <div class="comment-form__control">
          <label class="comment-form__label" [for]="'name' + review.id">Имя</label>
          <input class="comment-form__input" [id]="'name' + review.id" ngModel name="name" type="text" required />
        </div>

        <div class="comment-form__control">
          <label class="comment-form__label" [for]="'text' + review.id">Текст</label>
          <textarea class="comment-form__input" [id]="'text' + review.id" ngModel name="text" rows="3" required></textarea>
        </div>

        <div class="comment-form__control">
          <label class="comment-form__label" [for]="'email' + review.id">Электронная почта</label>
          <input class="comment-form__input" [id]="'email' + review.id" ngModel name="email" type="email" required />
        </div>

        <button class="comment-form__submit" type="submit">Оставить комментарий</button>
        <br>
        <button class="comment-form__cancel" type="button" (click)="toggleCommentForm(review, false)">Отменить</button>
      </form>
    </div>
  </div>
</ng-template>

<add-review-modal [uploadUrl]="mediaUploadUrl" (addReview)="onReviewAdd($event)"></add-review-modal>
